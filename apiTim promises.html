<!DOCTYPE html>
<html>
<head>
	<!--Initalize jQuery-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<!--Initialize Firebase-->
	<script src="https://www.gstatic.com/firebasejs/3.6.1/firebase.js"></script>
	<title>Music App</title>
</head>
<body>
	<form id="show-form">
		<input type="text" id="artist-input" value="radiohead"><br>
		<input type="text" id="location-input" value="austin, tx"><br>
		<input id="find-artistevents" type="submit" value="Search">
	</form>
	<div id="searched-artist"></div>
	<div id="playerDiv"></div>
	<div class="similar-artist"></div>

	<script type="text/javascript">
		$(document).ready(function(){
			//Global Variables
			var userLocation = "";
			var userArtist = "";
			var player = "";
			var similarPlayer = "";
			var database = "";
			//------------------------------------------------------//
						//Initialize Firebase Function
			//------------------------------------------------------//
			var initializeFirebase = function(){
				var config = {
					apiKey: "AIzaSyAfp1Bs3v2vGmBFzFurtDXduezcb8_ifWs",
					authDomain: "music-app-14ddc.firebaseapp.com",
					databaseURL: "https://music-app-14ddc.firebaseio.com",
					storageBucket: "music-app-14ddc.appspot.com",
					messagingSenderId: "95008115181"
				};
				firebase.initializeApp(config); // intializing firebase for our user data 
			};
			
			initializeFirebase();
			database = firebase.database(); // database variable 

			//------------------------------------------------------//
					//Searches Last.FM for User's Artist Input
			//------------------------------------------------------//
			var userArtistSearch = function(){
				//last fm query url for getting artist info
				var infoQueryURL = "http://ws.audioscrobbler.com/2.0/?method=artist.getinfo&artist=" + userArtist + "&api_key=1472636e9d44c81a12cdfb216ce752ac&format=json";
				//AJAX CALL FOR SEARCHED ARTIST INFO
				$.ajax({ url: infoQueryURL, method: "GET"}).done(function(response) {
					//show in artist div searched for artist info from lastfm
					console.log("Searched Artist log: ");
					console.log(response);
					
					$("#searched-artist").append("<h1>" + response.artist.name);
					$("#searched-artist").append("<input type='checkbox' data-name='" + response.artist.name + "'</input>"); //Talk to design team about what needs to happen with "selected" artists
					$("#searched-artist").append("<img src=" + response.artist.image[3]["#text"] + ">");
				}); //End AJAX Call 
			}; //End of userArtistSearch function

			//------------------------------------------------------//
			//Searches Spotify to generate player for User's Artist Input
			//------------------------------------------------------//			
			var userSpotifyPlayer = function(){
				var spotifyQueryURL = "https://api.spotify.com/v1/search?q=" + userArtist + "&type=artist";
				//AJAX call to produce Spotify Artist ID
				$.ajax({url: spotifyQueryURL, method: 'GET'}).done(function(response) {

					// Prints the Artist ID from the Spotify Object to console.
					var artistID = response.artists.items[0].id;

					// Then we build a SECOND URL to query another Spotify endpoint (this one for the tracks)
					var queryURLTracks = "https://api.spotify.com/v1/artists/" + artistID +"/top-tracks?country=US";
					// We then run a second AJAX call to get the tracks associated with that Spotify ID
					$.ajax({url: queryURLTracks, method: 'GET'}).done(function(trackResponse) {

						//Gets the tracks
						// console.log("Spotify Player log: ")
						// console.log(trackResponse);

						// Builds a Spotify player playing the top song associated with the artist. (NOTE YOU NEED TO BE LOGGED INTO SPOTIFY)
						player = '<iframe src="https://embed.spotify.com/?uri=spotify:track:'+trackResponse.tracks[0].id+'" frameborder="0" allowtransparency="true"></iframe>';
						// Appends the new player into the HTML
						$("#playerDiv").append(player);
					}); //End of second AJAX call to produce Spotify player
				});//End AJAX call
			}; //End userSpotifyPlayer function




			var similarArtistSearch = function(){
				return promise (resolve, reject){
					//last fm query url for getting similar artists 
					var similarQueryURL = "http://ws.audioscrobbler.com/2.0/?method=artist.getsimilar&artist=" + userArtist + "&api_key=1472636e9d44c81a12cdfb216ce752ac&format=json&limit=3";
					//Asynchronous AJAX call for similar artists
					$.ajax({url: similarQueryURL, method: "GET"}).done(function(response){
						var newDiv = $("<div>");
						resolve(newDiv);
					});//End of AJAX call to search for similar artists
				}
			};//End of similarArtistSearch function

			var similarSpotifyPlayer = function(similarArtistName){
				//Spotify player for similar artist top tracks
				var spotifyQueryURL = "https://api.spotify.com/v1/search?q=" + similarArtistName + "&type=artist";
				$.ajax({url: spotifyQueryURL, method: "GET"}).done(function(response){
					// Prints the entire object to console
					console.log("Similar Spotify Artist ID response: ");
					console.log(response);
					// Prints the Artist ID from the Spotify Object to console.
					var artistID = response.artists.items[0].id;
					console.log(artistID);
					// Then we build a SECOND URL to query another Spotify endpoint (this one for the tracks)
					var queryURLTracks = "https://api.spotify.com/v1/artists/" + artistID +"/top-tracks?country=US";
					// We then run a second AJAX call to get the tracks associated with that Spotify ID

					return $.ajax({url: queryURLTracks, method: 'GET'}).done(function(trackResponse) {
						// Gets the tracks
						console.log("Similar Artist top track: ");
						console.log(trackResponse);
						// Builds a Spotify player playing the top song associated with the artist. (NOTE YOU NEED TO BE LOGGED INTO SPOTIFY)
						similarPlayer = '<iframe src="https://embed.spotify.com/?uri=spotify:track:'+ trackResponse.tracks[0].id +'" frameborder="0" allowtransparency="true"></iframe>';
						console.log("similar player is: " + similarPlayer);
					});//End AJAX Call to get top track of similar artist
				});//End AJAX Call to get Spotify Similar Artist ID
			};//End of similarSpotifyPlayer function

			//Click event handler for when user searches for artist
			$("#find-artistevents").on('click', function() {
				$(".similar-artist").empty();
				$("#searched-artist").empty();
				$("#playerDiv").empty();
				userLocation = $("#location-input").val().trim(); // Variable for the searched location 
				userArtist = $("#artist-input").val().trim(); // Variable for the searchedArtist
				userArtistSearch();
				userSpotifyPlayer();
				similarArtistSearch();
				return false;
			});//end of #find-artistevents click handler
		}); //end of document ready
	</script>

</body>
</html>
<!-- 
							newDiv.append("<h2>" + similarArtistName);
							newDiv.append("<input type='checkbox' data-name='" + similarArtistName + "'</input>"); 
							newDiv.append("<img src=" + similarArtistImg + ">");
							newDiv.append("<a href='" + response.similarartists.artist[i].url+ "' target='_blank'>" + similarArtistName + "</a>");
							similarSpotifyPlayer(similarArtistName);
							newDiv.append(similarPlayer);
							$(".similar-artist").append(newDiv); -->
						<!-- for (var i=0; i<3; i++) {
							var similarArtistName = response.similarartists.artist[i].name;
							var similarArtistImg = response.similarartists.artist[i].image[3]["#text"];
							// Appends the new player into the HTML
						};//End of for loop -->
