<!DOCTYPE html>
<html>
<head>
	<!--Initalize jQuery-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<!--Initialize Firebase-->
	<script src="https://www.gstatic.com/firebasejs/3.6.1/firebase.js"></script>
	<title>Music App</title>
</head>
<body>
	<form id="show-form">
		<input type="text" id="artist-input" value="radiohead"><br>
		<input type="text" id="location-input" value="austin, tx"><br>
		<input id="find-artistevents" type="submit" value="Search">
	</form>
	<div id="searched-artist"></div>
	<div id="playerDiv"></div>
	<div class="similar-artist"></div>

	<script type="text/javascript">
		$(document).ready(function(){
			$("#find-artistevents").on('click', function() {
				var userLocation = $("#location-input").val().trim(); // Variable for the searched location 
				var userArtist = $("#artist-input").val().trim(); // Variable for the searchedArtist

				var config = {
					apiKey: "AIzaSyAfp1Bs3v2vGmBFzFurtDXduezcb8_ifWs",
					authDomain: "music-app-14ddc.firebaseapp.com",
					databaseURL: "https://music-app-14ddc.firebaseio.com",
					storageBucket: "music-app-14ddc.appspot.com",
					messagingSenderId: "95008115181"
				};

				firebase.initializeApp(config); // intializing firebase for our user data 

				var database = firebase.database(); // database variable 

				//last fm query url for getting artist info
				var infoQueryURL = "http://ws.audioscrobbler.com/2.0/?method=artist.getinfo&artist=" + userArtist + "&api_key=1472636e9d44c81a12cdfb216ce752ac&format=json";
				//last fm query url for getting similar artists 
				var similarQueryURL = "http://ws.audioscrobbler.com/2.0/?method=artist.getsimilar&artist=" + userArtist + "&api_key=1472636e9d44c81a12cdfb216ce752ac&format=json&limit=3";

				//AJAX CALL FOR SEARCHED ARTIST INFO
				$.ajax({ url: infoQueryURL, method: "GET"}).done(function(response) {

					//show in artist div searched for artist info from lastfm
					// console.log("Searched Artist log: ");
					// console.log(response);
					$("#searched-artist").empty();
					$("#searched-artist").append("<h1>" + response.name);
					$("#searched-artist").append("<input type='checkbox' data-name=" + response.name + "</input>"); //Talk to design team about what needs to happen with "selected" artists
					$("#searched-artist").append("<img src=" + response.artist.image[3]["#text"] + ">");


					var spotifyQueryURL = "https://api.spotify.com/v1/search?q=" + userArtist + "&type=artist";
					//AJAX call to produce Spotify Artist ID
					$.ajax({url: spotifyQueryURL, method: 'GET'}).done(function(response) {

						// Prints the Artist ID from the Spotify Object to console.
						var artistID = response.artists.items[0].id;

						// Then we build a SECOND URL to query another Spotify endpoint (this one for the tracks)
						var queryURLTracks = "https://api.spotify.com/v1/artists/" + artistID +"/top-tracks?country=US";
						// We then run a second AJAX call to get the tracks associated with that Spotify ID
						$.ajax({url: queryURLTracks, method: 'GET'}).done(function(trackResponse) {

							// Gets the tracks
							// console.log("Searched Artist log: ")
							// console.log(trackResponse);

							// Builds a Spotify player playing the top song associated with the artist. (NOTE YOU NEED TO BE LOGGED INTO SPOTIFY)
							var player = '<iframe src="https://embed.spotify.com/?uri=spotify:track:'+trackResponse.tracks[0].id+'" frameborder="0" allowtransparency="true"></iframe>';
							// Appends the new player into the HTML
			                $("#playerDiv").append(player);
						}); //End of second AJAX call to produce Spotify player
					});//End of Spotify Artist ID AJAX
				}); //End of AJAX call for searched artist in LastFM

				//Asynchronous AJAX call for similar artists
				$.ajax({url: similarQueryURL, method: "GET"}).done(function(response){
					console.log("Similar Artist log: ");
					console.log(response);
					$(".similar-artist").empty();

					var newDiv = $("<div>");

					for (var i=0; i<3; i++) {
						var similarArtistName = response.similarartists.artist[i].name;
						console.log(similarArtistName);
						var similarArtistImg = response.similarartists.artist[i].image[3]["#text"];
						newDiv.append("<input type='checkbox' data-name=" + similarArtistName + "</input>"); 
						newDiv.append("<img src=" + similarArtistImg + ">");
						newDiv.append("<h2>" + similarArtistName);
						newDiv.append("<a href='" + response.similarartists.artist[i].url+ "' target='_'>" + similarArtistName + "</a>");

						//Spotify player

						var spotifyQueryURL = "https://api.spotify.com/v1/search?q=" + similarArtistName + "&type=artist";
						$.ajax({url: spotifyQueryURL, method: 'GET'}).done(function(response) {

							// Prints the entire object to console
							console.log("Similar Artist response: ");
							console.log(response);

							// Prints the Artist ID from the Spotify Object to console.
							var artistID = response.artists.items[0].id;

							// Then we build a SECOND URL to query another Spotify endpoint (this one for the tracks)
							var queryURLTracks = "https://api.spotify.com/v1/artists/" + artistID +"/top-tracks?country=US";

							// We then run a second AJAX call to get the tracks associated with that Spotify ID
							$.ajax({url: queryURLTracks, method: 'GET'}).done(function(trackResponse) {

								// Gets the tracks
								console.log("Similar Artist top track: ");
								console.log(trackResponse);

								// Builds a Spotify player playing the top song associated with the artist. (NOTE YOU NEED TO BE LOGGED INTO SPOTIFY)
								var player = '<iframe src="https://embed.spotify.com/?uri=spotify:track:'+ trackResponse.tracks[0].id +'" frameborder="0" allowtransparency="true"></iframe>';

								// Appends the new player into the HTML
				                $("#playerDiv").append(player)

				                $(".similar-artist").append(newDiv);
							});//End second AJAX call to get tracks associated with Spotify ID
						});//End first AJAX call to get Spotify ID of artists 
					};//End for loop
				});//End similar artist AJAX call
				return false;
			});//end of #find-artistevents click handler
		}); //end of document ready
	</script>

</body>
</html>

